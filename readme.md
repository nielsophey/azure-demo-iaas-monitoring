# Azure IaaS exercises and demos

## Monitor an Scale-Set and add scaling and alerting

This exercise helps to understand the scaling and alerting in Azure scale-sets:

## Background

Adatum Corporation wants to explore monitoring capabilities in Azure
After completing this lab, you will be able to:

- Deploy Azure VM scale sets
- Implement monitoring and alerting by using Azure Monitor

__Lab Setup__
Estimated Time: 45 minutes
User Name: __Student__
Password: __Pa55w.rd__

### **Exercise 1:** Deploy Azure VM scale sets

The main tasks for this exercise are as follows:

1. Deploy an Azure VM scale set by using an Azure QuickStart template
2. Review autoscaling settings of the Azure VM scale set

### **Task 1:** Deploy an Azure VM scale set by using an Azure QuickStart template

1. From the lab virtual machine, start Microsoft Edge and browse to the Azure QuickStart template that deploys autoscale demo app on Ubuntu 16.04 at [Git Repro](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale).
2. Click Deploy to Azure and, when prompted, sign in by using the Microsoft account that has the Owner role in the target Azure subscription.
3. In the Azure Portal, on the Deploy VM Scale Set with Python Bottle server & AutoScale blade, specify the following settings and initiate the deployment:

   * Subscription: the name of the target Azure subscription
   * Resource group: the name of a new resource group **az3000101-LabRG**
   * Location: the name of the Azure region that is available in your subscription and which is closest to the lab location
   * Vm Sku: **StandardD1v2**
   * Vmss Name: **az01-vmss**
   * Instance count: **1**
   * Admin Username: **student**
   * Admin Password: **Pa55w.rd1234**
4. Wait for the deployment to complete. This will take about 5 minutes. 
    **Task 2: Review autoscaling settings of the Azure VM scale set**  

5. In Azure Portal, navigate to the **az01-vmss** blade, representing the newly deployed Azure VM scale set.
6. From the **az01-vmss** blade, navigate to the **az01-vmss - Scaling.**
7. Note that the Azure VM scale set is configured to scale dynamically based on a metric using the following criteria:
   * Scale out: increase instance count by 1 when average percentage of CPU > 60
   * Scale in: decrease instance count by 1 when average percentage of CPU < 30
   * Minimum number of instances: 1
   * Maximum number of instances: 10
8. Modify the maximum number of instances to 3.

**Result:** After you completed this exercise, you have deployed an Azure VM scale set and reviewed its autoscaling settings.

### **Exercise 2:** Implementing monitoring and alerting by using Azure Monitor

The main tasks for this exercise are as follows:

1. Create Azure VM scale set metrics-based alerts
2. Configure Azure VM scale set autoscaling-based notifications
3. Test Azure VM scale set monitoring and alerting.

### **Task 1:** Create Azure VM scale set metrics-based alert

1. In the Azure portal, navigate to the Monitor blade and, from there, switch to the Monitor - Metrics blade.
2. On the Monitor - Metrics blade, use the filter to display Avg Percentage CPU metric of the az01-vmss VM scale set resource.
3. Review the resulting chart and note the average percentage CPU within the last few minutes.
4. Navigate to the Monitor - Alerts blade.
5. From the Monitor - Alerts blade, create a new alert rule with the following settings:
   * Alert target: **az01-vmss**
   * Condition (Alert logic): **Greater than**
   * Time Aggregation (Alert logic): **Average**
   * Threshold (Alert logic): **60**
   * Period (grain): **Over the last 1 minutes**
   * Frequency: **Every 1 minute**
   * Alert rule name: **Percentage CPU of az01-vmss is greater than 60 percent**
   * Description: **Percentage CPU of az01-vmss is greater than 60 percent**
   * Severity: **Sev 3**
   * Enable rule upon creation: **Yes**
   * Action group name: **az30001 action group**
   * Short name: **az30001**
   * Subscription: the name of the Azure subscription you used in the previous exercise
   * Resource group: Default-ActivityLogAlerts (to be created)
   * Action name: **az30001-email**
   * Action type: **Email/SMS/Push/Voice**
   * Email/SMS/Push/Voice: an email address, a mobile phone number, or a phone number that you want to use to receive alerts generated by this rule

**Note:** It can take up to 10 minutes for a metric alert rule to become active

### **Task 2:** Configure Azure VM scale set autoscaling-based notifications

1. In the Azure portal, navigate to the **Monitor - Autoscale** blade.
2. In the list of resources capable of autoscaling, click **az01-vmss.**
3. On the **Autoscale setting** blade, click the **Notify tab** heading, configure the following settings, and save your changes:  

   * Email administrators: enabled
   * Email administrators: enabled
   * Email co-administrators: disabled
   * Additional administrator emails(s): add an email address that you want to use to receive notifications about autoscaling events

### **Task 3:** Test Azure VM scale set monitoring and alerting.

1. In the Azure portal, navigate to the **az01-vmss** blade, representing the Azure VM scale set you deployed in the previous exercise of this lab.
2. From the **az01-vmss** blade, identify the value of the **Public IP address** assigned to the front end of the load balancer associated with the VM scale set.
3. From the lab computer, start Microsoft Edge and browse to http://Public IP address:9000** (where **Public IP address** is the IP address you identified in the previous step)
4. On the Worker interface on **az01-vmss000000** page, click the Start work link.
5. Use the **CPU (average)** chart on the **az01-vmss**blade to monitor changes to the CPU utilization. 
    **Note:** Alternatively, you can navigate back to the **Monitor - Metrics blade** and use the filter to display Avg Percentage CPU metric of the **az01-vmss** VM scale set resource. 
    **Note:** You should receive an alert regarding increased CPU utilization within a couple of minutes
6. Switch to the **az01-vmss** - Instances blade in order to identify the number of instances in the **az01-vmss** VM scale set. 
    **Note:** Alternatively, you can navigate back to the Monitor - Autoscale blade, in the list of resources capable of autoscaling, click az01-vmss, on the Autoscale settings blade, click Run history, and then review the list of autoscale events. 
    **Note:** Autoscaling should be triggered within a couple of minutes.
7. Switch to the Microsoft Edge window displaying Worker interface on **az01-vmss000000** page and click the Stop work link.
8. Monitor decrease in CPU utilization and scaling in events using the same methods that you used when scaling out the VM scale set.

**Result:** After you completed this exercise, you have implemented and tested monitoring and alerting by using Azure Monitor. 